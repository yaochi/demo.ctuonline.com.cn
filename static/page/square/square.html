<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
    	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    	<title>广场 - 中国电信网上大学</title>
    	<meta name="apple-mobile-web-app-capable" content="yes" />
    	<meta name="apple-mobile-web-app-status-bar-style" content="black" /> 
    	<meta name="viewport" content="width=480;initial-scale=1;maximum-scale=1;target-densitydpi=high-dpi;user-scalable=no" />
    	<style>
    		/* RESET */
    		html,body,div,ul,ol,li,dl,dt,dd,h1,h2,h3,h4,h5,h6,pre,form,p,blockquote,fieldset,input { margin: 0; padding: 0; }
    		h1,h2,h3,h4,h5,h6,pre,code,address,caption,cite,code,em,strong,th { font-size: 1em; font-weight: normal; font-style: normal; }
    		ul,ol { list-style: none; }
    		fieldset,img { border: none; }
    		caption,th { text-align: left; }
    		table { border-collapse: collapse; border-spacing: 0; }
    		
    		/* LAYOUT */
    		body { background: #fff; font: normal normal normal 18px/1.3 'Helvetica Neue', 'Segoe UI', Tahoma, 'Hiragino Sans GB', 'Hiragino Kaku Gothic Pro', 'Microsoft YaHei', sans-serif; color: #515e6c; text-rendering: optimizelegibility; -webkit-font-smoothing: antialiased; }
    		a:link, a:visited, a:active { text-decoration: none; }
    		a { color: #515e6c; }
    		.hm { text-align: center; }
    		.fpr { position: relative; }
    		.reHeight { overflow: hidden; zoom: 1; }
    		.avt { -moz-border-radius: 5px; -webkit-border-radius: 5px; border-radius: 5px; padding: 4px; width: 80px; height: 80px; margin: 13px 0 16px 16px;
				background: #fff; border: 1px solid #d6d6d6; display:block; }
				.avt img { width: 80px; height: 80px; }
    		
    		#ribbon { width: 168px; height: 63px; display: block; background: url(assets/image/ribbon.png) no-repeat 0 0; position: absolute; left: 0; top: 24px; }
    		#recommendList { margin-top: 100px; width: 100%; border: 0; table-layout: fixed; }
    			#recommendList tr { border-bottom: 1px dashed #e5e5e5; }
    				#recommendList tr:last-child { border-bottom: none; }
    			#recommendList .avtTD { width: 120px; text-align: center; vertical-align: top; }
    			#recommendList .rlTitle { font-size: 24px; font-weight: bolder; margin-top: 10px; display: inline-block; }
    			#recommendList .rlIntro { font-size: 24px; color: #bfbfbf; margin: 4px 10px 10px 0; }
    		.addTD { vertical-align: middle; text-align: center; width: 160px; border-left: 1px dashed #e5e5e5; }
    		.addFollowBtn { width: 122px; height: 52px; background: url(assets/image/addFollowBtns.png) no-repeat 0 0; display: block; margin-left: 20px; }
    		.addForumBtn { width: 122px; height: 52px; background: url(assets/image/addForumBtns.png) no-repeat 0 0; display: block; margin-left: 20px; }
    		.proing { background-position: 0 -57px; }
    		.done { background-position: 0 -114px; }
    		.wprove { background-position: 0 -171px; }
       	</style>
    </head>
    <body>
    	<div id="ribbon"></div>
    	<table id="recommendList"></table>
	</body>
	<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.2.min.js" type="text/javascript"></script>
	<script src="http://home.myctu.cn/static/js/jquery-md5.js" type="text/javascript"></script>
	<script type="text/javascript">
		//cracking cross domain problem
		document.domain="myctu.cn";
		
		$(document).ready(function() {
			var url = window.location.href;
			var paraString = url.substring(url.indexOf("?")+1, url.length).split("&");
			var uid;
			
			if(paraString != null) {
				var parameters = {"key":[], "value":[]};
				var tempStr;
			
				for (var i in paraString) {
					//alert(paraString[i]);
					tempStr = paraString[i].split("=");
					//alert(tempStr);
					parameters.key.push(tempStr[0]);
					parameters.value.push(tempStr[1]);
				}
	
				/* 参数分离完毕 开始判断 */
				for (var i in parameters.key) {
					if(parameters.key[i] == "uid") {
						uid = parameters.value[i];
					}
				}		
			}
			
			var usrs = jQuery.parseJSON('{' + 
					   '"id": [5644473, 5644472, 422, 5644475, 5264125, 5636216, 609, 1536],' +
					   '"name": ["翼博小助手", "社会渠道经理", "岗位技能认证", "工作能力宝典", "战略解读", "管理小故事", "移动学习", "云南学习专区"],' +
					   '"type": ["uid", "uid", "fid", "uid", "uid", "uid", "fid", "fid"],' + 
					   '"fIntro": ["", "", "拟将今后认证过程中所有通知，公告，攻略，问题解答汇集于此！ 拟将今后认证规划前的非官方讨论，投票，问卷，呈现于此！ 记录集团认证足迹！ 篆刻各省认证团队的辛勤耕耘！！", "", "", "", "移动学习应用下载、信息发布，收集需求；研究探讨移动学习应用发展趋势、最新前沿；为学员提供方便快捷的移动学习服务", "云南公司2012年能力素质提升培训信息查询、资料下载和在线交流专区"],' + 
					   '"fIcns": ["", "", "01.png", "", "", "", "02.png", "03.png"]' + 
					   '}');
			jQuery.each(usrs.id, function(i, value) {
				var recLi = $('<tr></tr>');
				
				var avtTD = $('<td class="avtTD"></td>');
				if(usrs.type[i] == 'uid') {
					avtTD.append('<a class="avt" href="mesn#type=user&id=' + value + '&name=' + usrs.name[i] + '">' + 
								  '<img src="http://home.myctu.cn/uc_server/avatar.php?uid=' + value + '&size=big" /></a>');
				} else if(usrs.type[i] == 'fid') {
					avtTD.append('<a class="avt" href="mesn#type=zone&id=' + value + '&name=' + usrs.name[i] + '">' + 
								  '<img src="assets/image/fIcns/' + usrs.fIcns[i] + '" /></a>');
				}
				
				var contentTD = $('<td style="vertical-align: top;"></td>');
				if(usrs.type[i] == 'uid') {
					contentTD.append('<span class="rlTitle"><a href="mesn#type=user&id=' + value + '&name=' + usrs.name[i] + '">' + usrs.name[i] + '</a></span>');
				} else if(usrs.type[i] == 'fid') {
					contentTD.append('<span class="rlTitle"><a href="mesn#type=zone&id=' + value + '&name=' + usrs.name[i] + '">' + usrs.name[i] + '</a></span>');
								  
				}
				contentTD.append('<p class="rlIntro"><img src="assets/image/loading.gif" /></p>');
				
				var addTD = $('<td class="addTD"></td>');
				addTD.append('<img src="assets/image/loading.gif" />');
				
				recLi.append(avtTD, contentTD, addTD);
				$("#recommendList").append(recLi);
				
				//Getting Data
				if(usrs.type[i] == 'uid') {
					jQuery.getJSON('http://home.myctu.cn/api/blog/api_feed.php?uid=' + value + '&type=user&num=0&shownum=1&jsoncallback=1234', function(data){
						var feed = data.feed[0];
						var rlIntroText = '';
						if(jQuery.trim(feed.body_data.summary) != '') {
							rlIntroText = jQuery.trim(feed.body_data.summary);
						} else if(jQuery.trim(feed.body_data.subject) != '') {
							rlIntroText = jQuery.trim(feed.body_data.subject);
						} else if(jQuery.trim(feed.body_general) != '') {
							rlIntroText = jQuery.trim(feed.body_general);
						}
						$('.rlIntro', recLi).text(textSUB(rlIntroText));
					});
					
					jQuery.getJSON('http://home.myctu.cn/api/blog/api_relationship.php?fromuid=' + uid + '&touid=' + value, function(data) {
						if(data.followed == 1 || data.followed == 3) {
						 	addTD.html('<span class="addFollowBtn done"></span>');
						} else {
							var addFollowBtn = $('<a href="javascript:;" class="addFollowBtn"></a>');
							addFollowBtn.click(function() {
								addTD.html('<a href="javascript:;" class="addFollowBtn proing"></a>');
								follow(uid, value, addTD);
							});
							addTD.html('');
							addTD.append(addFollowBtn);
						}
					});
					
					
				} else if(usrs.type[i] == 'fid') {
					$('.rlIntro', recLi).text(textSUB(usrs.fIntro[i]));
					
					jQuery.getJSON('http://home.myctu.cn/api/blog/api_forumcart.php?uid=' + uid + '&fid=' + value, function(data) {
						if (data.forum.ismember == '1' || data.forum.ismember == '3') {
							addTD.html('<span class="addForumBtn done"></span>');
						} else if (data.forum.ismember == '2') {
							addTD.html('<span class="addForumBtn wprove"></span>');
						} else if (data.forum.ismember == '0') {
							if (data.forum.jointype == '0' || data.forum.jointype == '2') {
								var addForumBtn = $('<a href="javascript:;" class="addForumBtn"></a>');
								addForumBtn.click(function() {
									addTD.html('<a href="javascript:;" class="addForumBtn proing"></a>');
									joinForum(uid, value, addTD, data.forum.jointype);
								});
								addTD.html('');
								addTD.append(addForumBtn);
							}
						}
					});
				}
			});
		});
	
		function textSUB(str) {
			str = str.toString();
			str = str.replace(/&nbsp;/g, '');
			str = str.replace(/(<([^>]+)>)/gi, ''); //clear the html code
			if(str.length > 32) {
				return str.substring(0, 32) + "...";
			} else return str;
		}
		
		function follow(fromuid, touid, source, type) {
			jQuery.getJSON("http://home.myctu.cn/api/blog/api_follow.php?fromuid=" + fromuid + "&" + "touid=" + touid + "&" + getMD5([fromuid, touid]),function(data){
				if(data.success =='Y'){
					$(source).html('<span class="addFollowBtn done"></span>');
				}else{
					alert("非常抱歉 可能由于网络等原因 加关注操作失败 请稍后再试");
					$(source).html('<a href="javascript:;" class="addFollowBtn"></a>');
				}
			});
		}
		
		function joinForum(uid, fid, source, jointype){
			jQuery.getJSON("http://home.myctu.cn/api/blog/api_joinforum.php?uid=" + uid + "&" + "fid=" + fid + "&" + getMD5([uid, fid]), function(data){
				if (data != null) {
					if(data.success == 'Y'){
						if(jointype == '0'){
							$(source).html('<span class="addForumBtn done"></span>');
						}else if(jointype == '1'){
							$(source).html('<span class="addForumBtn wprove"></span>');
						}
					}else{
						alert("非常抱歉 可能由于网络等原因 加入专区操作失败 请稍后再试");
						$(source).html('<a href="javascript:;" class="addForumBtn"></a>');
					}
				}
			})
		}
		
		function getMD5(paraArray) {
			if(paraArray != null && paraArray != "") {
				var str = "esn";
				for(var i = 0; i < paraArray.length; i++) {
					str += paraArray[i];
				}
				return "code=" + jQuery.md5(str);
			}
		}
	</script>
</html>